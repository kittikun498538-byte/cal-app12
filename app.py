import streamlit as st
import math

# 1. р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕▓р╕Зр╕кр╕гр╕╕р╕Ыр╕Ьр╕е (Pop-up)
@st.dialog("р╣Гр╕Ър╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕▓р╕Ур╕Бр╕▓р╕г")
def show_summary_dialog(final_billed, selected_items):
    st.write("### р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З:")
    if selected_items:
        for item in selected_items:
            st.write(f"тЬЕ {item['name']} р╕Ир╕│р╕Щр╕зр╕Щ {item['qty']} р╕гр╕▓р╕вр╕Бр╕▓р╕г")
    else:
        st.write("р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Ар╕ер╕╖р╕нр╕Бр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М")
    
    st.divider()
    # р╣Гр╕Кр╣Йр╕Кр╕╖р╣Ир╕нр╕лр╕▒р╕зр╕Вр╣Йр╕нр╣Гр╕лр╕бр╣Ир╕Хр╕▓р╕бр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕ер╣Ир╕▓р╕кр╕╕р╕Ф
    st.info(f"## р╕гр╕▓р╕Др╕▓р╣Ар╕кр╕Щр╕нр╕Др╣Ир╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕ер╕░р╕Ър╕гр╕┤р╕Бр╕▓р╕г(р╣Др╕бр╣Ир╕гр╕зр╕бр╕ар╕▓р╕йр╕╡р╕бр╕╣р╕ер╕Др╣Ир╕▓р╣Ар╕Юр╕┤р╣Ир╕б): {final_billed:,.0f} р╕Ър╕▓р╕Ч")
    st.write("*(р╕гр╕▓р╕Др╕▓р╕Щр╕╡р╣Йр╕гр╕зр╕бр╕Др╣Ир╕▓р╣Бр╕гр╕З р╕Др╣Ир╕▓р╕Ыр╕ер╕Фр╕кр╕▒р╕Ъ р╣Бр╕ер╕░р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з)*")

def main():
    st.set_page_config(page_title="р╕гр╕░р╕Ър╕Ър╕Др╕│р╕Щр╕зр╕Ур╕Др╣Ир╕▓р╕Ър╕гр╕┤р╕Бр╕▓р╕г", layout="wide")
    
    # р╕лр╕▒р╕зр╕Вр╣Йр╕нр╕лр╕ер╕▒р╕Б
    st.title("р╕Ыр╕гр╕░р╕бр╕▓р╕Ур╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Бр╕ер╕░р╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓р╕лр╕бр╣Йр╕нр╣Бр╕Ыр╕ер╕З")
    st.divider()

    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 1: р╕Др╣Ир╕▓р╣Бр╕гр╕Зр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ ---
    st.header("р╕Др╣Ир╕▓р╣Бр╕гр╕Зр╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ")
    staff_data = [
        {"level": "р╕Юр╕Кр╕З.3", "rate": 87.77}, {"level": "р╕Юр╕Кр╕З.4", "rate": 103.48},
        {"level": "р╕Юр╕Кр╕З.5", "rate": 125.30}, {"level": "р╕Юр╕Кр╕З.6", "rate": 164.19},
    ]
    total_wage = 0
    cols_h = st.columns([2, 2, 2, 2, 2])
    cols_h[0].write("**р╕гр╕░р╕Фр╕▒р╕Ъ**"); cols_h[1].write("**р╕гр╕▓р╕Др╕▓/р╕Кр╕б**")
    cols_h[2].write("**р╕Кр╕▒р╣Ир╕зр╣Вр╕бр╕З**"); cols_h[3].write("**р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Щ**"); cols_h[4].write("**р╕гр╕зр╕б**")

    for s in staff_data:
        c1, c2, c3, c4, c5 = st.columns([2, 2, 2, 2, 2])
        c1.text(s["level"])
        c2.text(f"{s['rate']:.2f}")
        hr = c3.number_input("р╕Кр╕б", value=1, key=f"h_{s['level']}", label_visibility="collapsed")
        qty = c4.number_input("р╕Др╕Щ", value=0, key=f"q_{s['level']}", label_visibility="collapsed")
        row_w = s['rate'] * hr * qty
        total_wage += row_w
        c5.text(f"{row_w:,.2f}")

    st.divider()

    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 2: р╕Др╣Ир╕▓р╕Ыр╕ер╕Фр╕кр╕▒р╕Ъ ---
    st.header("р╕Др╣Ир╕▓р╕Ыр╕ер╕Фр╕кр╕▒р╕Ъ")
    cs1, cs2, cs3 = st.columns([4, 4, 2])
    cs1.number_input("р╕гр╕▓р╕Др╕▓р╕Хр╣Ир╕нр╕Др╕гр╕▒р╣Йр╕З", value=570.0, disabled=True) 
    s_qty = cs2.number_input("р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕гр╕▒р╣Йр╕З", value=0)
    total_switch = 570.0 * s_qty
    cs3.metric("р╕гр╕зр╕бр╕Др╣Ир╕▓р╕Ыр╕ер╕Фр╕кр╕▒р╕Ъ", f"{total_switch:,.2f}")
    
    st.divider()

    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 3: р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Бр╕ер╕░р╕Ър╕гр╕┤р╕Бр╕▓р╕г (р╣Ар╕Юр╕┤р╣Ир╕б Snake Guard) ---
    st.header("р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Бр╕ер╕░р╕Ър╕гр╕┤р╕Бр╕▓р╕г")
    items_list = [
        {"name": "Bird Spikes", "price": 325.0},
        {"name": "LIGHTNING ARRESTER COVERS", "price": 110.0},
        {"name": "DROPOUT FUSE CUTOUT COVERS", "price": 670.0},
        {"name": "TRANSFORMER BUSHING COVERS", "price": 294.0},
        {"name": "р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Snake Guard", "price": 250.0}, # р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Гр╕лр╕бр╣Ир╕Хр╕▓р╕бр╕Др╕│р╕кр╕▒р╣Ир╕З
        {"name": "р╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓р╕лр╕бр╣Йр╕нр╣Бр╕Ыр╕ер╕З р╣Др╕бр╣Ир╣Ар╕Бр╕┤р╕Щ 250(kVA)", "price": 3000.0},
        {"name": "р╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓р╕лр╕бр╣Йр╕нр╣Бр╕Ыр╕ер╕З 250(kVA)-1,500(kVA)", "price": 7000.0},
        {"name": "р╕Ър╕│р╕гр╕╕р╕Зр╕гр╕▒р╕Бр╕йр╕▓р╕лр╕бр╣Йр╕нр╣Бр╕Ыр╕ер╕З р╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 1,500(kVA)", "price": 9000.0}
    ]
    total_items = 0
    selected_items = []
    
    ih = st.columns([4, 2, 2, 2])
    ih[0].write("**р╕гр╕▓р╕вр╕Бр╕▓р╕г**"); ih[1].write("**р╕гр╕▓р╕Др╕▓/р╕лр╕Щр╣Ир╕зр╕в**")
    ih[2].write("**р╕Ир╕│р╕Щр╕зр╕Щ**"); ih[3].write("**р╕гр╕зр╕б**")

    for i, item in enumerate(items_list):
        ic1, ic2, ic3, ic4 = st.columns([4, 2, 2, 2])
        ic1.text(item["name"]) 
        ic2.number_input("р╕гр╕▓р╕Др╕▓", value=item["price"], key=f"p_{i}", disabled=True, label_visibility="collapsed")
        q = ic3.number_input("р╕Ир╕│р╕Щр╕зр╕Щ", value=0, key=f"qty_{i}", label_visibility="collapsed")
        
        row_p = item["price"] * q
        total_items += row_p
        ic4.text(f"{row_p:,.2f}")
        
        if q > 0:
            selected_items.append({"name": item["name"], "qty": q})

    st.divider()

    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 4: р╕кр╕гр╕╕р╕Ыр╕Зр╕Ър╕Ыр╕гр╕░р╕бр╕▓р╕У ---
    raw_total = total_wage + total_switch + total_items
    final_billed = math.ceil(raw_total / 100) * 100 if raw_total > 0 else 0
    
    st.subheader("ЁЯУК р╕кр╕гр╕╕р╕Ыр╕Зр╕Ър╕Ыр╕гр╕░р╕бр╕▓р╕У")
    st.write(f"р╕гр╕▓р╕Др╕▓р╕гр╕зр╕бр╕Др╕│р╕Щр╕зр╕Ур╕Ир╕гр╕┤р╕З: {raw_total:,.2f} р╕Ър╕▓р╕Ч")
    # р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Кр╕╖р╣Ир╕нр╕вр╕нр╕Фр╕гр╕зр╕бр╕Хр╕▓р╕бр╕кр╕▒р╣Ир╕З
    st.info(f"### р╕гр╕▓р╕Др╕▓р╣Ар╕кр╕Щр╕нр╕Др╣Ир╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕ер╕░р╕Ър╕гр╕┤р╕Бр╕▓р╕г(р╣Др╕бр╣Ир╕гр╕зр╕бр╕ар╕▓р╕йр╕╡р╕бр╕╣р╕ер╕Др╣Ир╕▓р╣Ар╕Юр╕┤р╣Ир╕б): {final_billed:,.0f} р╕Ър╕▓р╕Ч")

    # --- р╕Ыр╕╕р╣Ир╕бр╕Бр╕Фр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Ыр╕┤р╕Фр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕▓р╕Зр╣Гр╕лр╕бр╣И (р╣Ар╕нр╕▓р╕Др╕│р╕зр╣Ир╕▓ р╣Бр╕Др╕Ыр╕лр╕Щр╣Йр╕▓р╕Ир╕н р╕нр╕нр╕Бр╕Хр╕▓р╕бр╕кр╕▒р╣Ир╕З) ---
    st.write("")
    if st.button("ЁЯУ▒ р╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Йр╕▓р╕кр╕гр╕╕р╕Ыр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Ир╣Йр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓", type="primary", use_container_width=True):
        show_summary_dialog(final_billed, selected_items)

if __name__ == "__main__":
    main()